from grail import Input, external

target_file_input: str | None = Input("target_file", default=None)


@external
async def read_file(path: str) -> str:
    """Read the text contents of a file."""
    ...


@external
async def file_exists(path: str) -> bool:
    """Check if a file or directory exists."""
    ...


async def _read_optional(path: str) -> str | None:
    if await file_exists(path=path):
        return await read_file(path=path)
    return None


async def _resolve_target_file() -> str | None:
    if target_file_input:
        return target_file_input.strip()
    stored = await _read_optional(path=".remora/target_file")
    if stored:
        return stored.strip()
    return None


def _line_count(content: str) -> int:
    if not content:
        return 0
    return len(content.splitlines())


try:
    target_file = await _resolve_target_file()
    if not target_file:
        raise ValueError("Target file not found for linting.")
    content = await read_file(path=target_file)
    line_count = _line_count(content)
    raw_result = {"content": content, "lines": line_count}
    result = {
        "result": raw_result,
        "summary": f"Read {line_count} lines from {target_file}",
        "knowledge_delta": {
            "last_read_file": target_file,
            "last_read_lines": line_count,
        },
        "outcome": "success",
    }
except Exception as exc:
    result = {
        "result": None,
        "summary": f"Error: {exc}",
        "knowledge_delta": {},
        "outcome": "error",
        "error": str(exc),
    }

result
