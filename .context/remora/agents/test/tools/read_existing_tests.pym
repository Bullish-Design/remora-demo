from grail import Input

source_code: str = Input("source_code")
file_path: str = Input("file_path")
existing_tests: str = Input("existing_tests", default="")


def _default_test_path(target_file: str) -> str:
    filename = target_file.split("/")[-1]
    module_name = filename.rsplit(".", 1)[0]
    return f"tests/test_{module_name}.py"


try:
    if not file_path:
        raise ValueError("Target file is required.")
    
    test_path = _default_test_path(file_path)
    
    if not existing_tests:
        raw_result = {"content": "", "path": None}
        result = {
            "result": raw_result,
            "summary": "No existing tests found",
            "knowledge_delta": {
                "existing_tests_present": False,
                "existing_tests_path": None,
            },
            "outcome": "partial",
        }
    else:
        raw_result = {"content": existing_tests, "path": test_path}
        result = {
            "result": raw_result,
            "summary": f"Loaded existing tests from {test_path}",
            "knowledge_delta": {
                "existing_tests_present": True,
                "existing_tests_path": test_path,
            },
            "outcome": "success",
        }
except Exception as exc:
    result = {
        "result": None,
        "summary": f"Error: {exc}",
        "knowledge_delta": {},
        "outcome": "error",
        "error": str(exc),
    }

result
