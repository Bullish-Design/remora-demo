from grail import Input

DEFAULT_STYLE = "google"
ALLOWED_STYLES = {"google", "numpy", "sphinx"}

remora_config: str = Input("remora_config", default="")


def _extract_style(content: str) -> str | None:
    lines = content.splitlines()
    in_operations = False
    operations_indent = 0
    in_docstring = False
    docstring_indent = 0

    for line in lines:
        stripped = line.strip()
        if not stripped or stripped.startswith("#"):
            continue
        indent = len(line) - len(line.lstrip())
        if stripped.startswith("operations:"):
            in_operations = True
            operations_indent = indent
            in_docstring = False
            continue
        if in_operations and indent <= operations_indent:
            in_operations = False
            in_docstring = False

        if in_operations and stripped.startswith("docstring:"):
            in_docstring = True
            docstring_indent = indent
            continue

        if in_docstring and indent <= docstring_indent:
            in_docstring = False

        if in_docstring and stripped.startswith("style:"):
            _, value = stripped.split(":", 1)
            style = value.strip()
            if style:
                return style
    return None


try:
    if remora_config:
        style = _extract_style(remora_config)
        if style in ALLOWED_STYLES:
            result = style
        else:
            result = DEFAULT_STYLE
    else:
        result = DEFAULT_STYLE
except Exception:
    result = DEFAULT_STYLE

result
